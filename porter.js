// Generated by CoffeeScript 1.6.3
(function() {
  var PORT, SECRET, authed, checkPort, net, portfinder, server, upnode, _ref;

  upnode = require('upnode');

  portfinder = require('portfinder');

  net = require('net');

  PORT = 7003;

  SECRET = (_ref = process.env.PORTER_PASS) != null ? _ref : 'o87asdoa87sa';

  authed = {
    port: function(cb) {
      return portfinder.getPort(cb);
    }
  };

  server = upnode(function(client, conn) {
    return this.auth = function(secret, cb) {
      if (secret === SECRET) {
        return cb(null, authed);
      }
      return cb('DENIED');
    };
  });

  checkPort = function() {
    var tester;
    tester = net.createServer();
    tester.on('error', function(error) {
      return setTimeout(function() {
        return checkPort();
      }, 10 * 60 * 1000);
    });
    return tester.listen(PORT, function() {
      return tester.close(function() {
        return server.listen(PORT);
      });
    });
  };

  checkPort();

  console.log("Server listening on " + PORT);

  module.exports = {
    authed: authed
  };

}).call(this);
